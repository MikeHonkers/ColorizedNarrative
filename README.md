# ColorizedNarrative

## –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –æ—Ç—á—ë—Ç –∫–æ–º–∞–Ω–¥—ã:

### –ê–ª–µ–∫—Å–µ–π –ü–∞–≤–ª–æ–≤.
–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ DreamBoothDataset –¥–ª—è FLUX
 ‚Ä¢ –ü–µ—Ä–µ–ø–∏—Å–∞–ª DreamBoothDataset, —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç—å, –∞ —á–∏—Ç–∞—Ç—å –∏ –∞—É–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –ª–µ–Ω–∏–≤–æ –≤ getitem.
 ‚Ä¢ –î–æ–±–∞–≤–∏–ª –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤: —á–µ—Ä–µ–∑ ü§ó Datasets (dataset_name) –∏ —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—É—é –ø–∞–ø–∫—É (instance_data_dir).
 ‚Ä¢ –†–µ–∞–ª–∏–∑–æ–≤–∞–ª –ø–æ–¥–¥–µ—Ä–∂–∫—É caption_column: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é –∏—Ö, –∏–Ω–∞—á–µ ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π instance_prompt.
 ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏–ª –ø–æ–¥–¥–µ—Ä–∂–∫—É prior-preservation (class_data_root, class-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è).

–ö–æ–ª–ª–∞—Ç–æ—Ä –∏ prior-preservation
 ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–∏–ª collate_fn, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç pixel_values –∏ prompts –∏ –ø—Ä–∏ --with_prior_preservation –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–ª–∞—Å—Å-—á–∞—Å—Ç—å –≤ —Ç–æ—Ç –∂–µ –±–∞—Ç—á.
 ‚Ä¢ –†–∞–∑–Ω—ã–µ learning rate‚Äô—ã –¥–ª—è FLUX
 ‚Ä¢ –í—ã–Ω–µ—Å LoRA-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã transformer –∏ text_encoder_one –≤ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä-–≥—Ä—É–ø–ø—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞.
 ‚Ä¢ –ó–∞–¥–∞–ª –æ–±—â–∏–π --learning_rate –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–∞ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π --text_encoder_lr –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–Ω–∫–æ–¥–µ—Ä–∞.
 ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–∏–ª –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä—ã AdamW –∏ prodigy, —É—á—ë–ª –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ LR –∏ weight decay –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–Ω–∫–æ–¥–µ—Ä–∞.
 ‚Ä¢ –¢—é–Ω–∏–Ω–≥ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–Ω–∫–æ–¥–µ—Ä–∞ –ø–æ–¥ —Ä—É—Å—Å–∫–∏–π
 ‚Ä¢ –í–∫–ª—é—á–∏–ª –æ–±—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–Ω–∫–æ–¥–µ—Ä–∞ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ --train_text_encoder.
 ‚Ä¢ –î–æ–±–∞–≤–∏–ª –æ—Ç–¥–µ–ª—å–Ω—ã–π lr –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–Ω–∫–æ–¥–µ—Ä–∞, —á—Ç–æ–±—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø–æ–¥ —Ä—É—Å—Å–∫–∏–µ –ø—Ä–æ–º–ø—Ç—ã.
 ‚Ä¢ –ü—Ä–∞–≤–∫–∏ –≤ train_text_to_image_lora_sdxl.py (SDXL LoRA)
 ‚Ä¢ –î–æ–±–∞–≤–∏–ª –∞—Ä–≥—É–º–µ–Ω—Ç --text_encoder_lr –≤ —Å–∫—Ä–∏–ø—Ç SDXL.
 ‚Ä¢ –°–¥–µ–ª–∞–ª –ª–æ–≥–∏–∫—É: –±–µ–∑ --text_encoder_lr –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–æ–¥–∏–Ω LR), —Å –Ω–∏–º ‚Äî –¥–µ–ª—è—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ UNet –∏ text encoder c —Ä–∞–∑–Ω—ã–º–∏ LR.
 ‚Ä¢ –û–±—ë—Ä—Ç–∫–∏ bash-—Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
 ‚Ä¢ –ù–∞–ø–∏—Å–∞–ª –æ–±—ë—Ä—Ç–æ—á–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è FLUX –∏ SDXL, –∫–æ—Ç–æ—Ä—ã–µ:
 ‚Ä¢ –¥–æ–±–∞–≤–ª—è—é—Ç --train_text_encoder –∏ --text_encoder_lr=...;
 ‚Ä¢ –∑–∞–¥–∞—é—Ç —Å–≤–æ–π output_dir, –Ω–µ –ª–æ–º–∞—è –±–∞–∑–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã.

 ### –ú–∏—Ö–∞–∏–ª –ö–∞–ª–∏–Ω–∫–∏–Ω.
 1.  –ü–∞–π–ø–ª–∞–π–Ω –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Ü–µ–Ω—ã:
 ‚Ä¢ –∫–ª–∞—Å—Å ScenePipeline –Ω–∞ Qwen/Qwen2.5-3B-Instruct (AutoModelForCausalLM/AutoTokenizer, device_map="auto", –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑ —Å—ç–º–ø–ª–∏–Ω–≥–∞),
 ‚Ä¢ –µ–¥–∏–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ llm() –¥–ª—è –≤—Å–µ—Ö LLM-–≤—ã–∑–æ–≤–æ–≤,
 ‚Ä¢ normalize_text: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä—É—Å—Å–∫–∏—Ö —Ä–µ–ø–ª–∏–∫ (–ø—É–Ω–∫—Ç—É–∞—Ü–∏—è –∏ –æ–ø–µ—á–∞—Ç–∫–∏)
 ‚Ä¢ extract_scene: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∏—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ —Ç–µ–∫—Å—Ç—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, —Å—Ç—Ä–æ–≥–∏–π JSON-—Ñ–æ—Ä–º–∞—Ç {"scene", "style", "details"} 
 ‚Ä¢ build_prompt: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è details (1‚Äì5 —Å–ª–æ–≤, –º–∞–∫—Å–∏–º—É–º 4 –¥–µ—Ç–∞–ª–∏), —Å–±–æ—Ä —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –ø–æ–¥ T2I-–º–æ–¥–µ–ª—å (scene + details + style + "–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å–≤–µ—Ç, –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ"),
 ‚Ä¢ process: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç payload —Å –¥–∏–∞—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ segments, –ø–æ –∫–∞–∂–¥–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É –¥–µ–ª–∞–µ—Ç LLM-–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞, –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Ä–µ–ø–ª–∏–∫–∏ –ø–æ speaker, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ø–∏–∫–µ—Ä–∞ —Å—Ç—Ä–æ–∏—Ç scene/style/details –∏ visual_prompt, –Ω–∞ –≤—ã—Ö–æ–¥–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ segments —Å normalized_text –∏ —Å–ø–∏—Å–æ–∫ speakers —Å –ø–æ–ª—è–º–∏ speaker/text/scene/style/details/visual_prompt.
 
 2. –î–µ–º–æ-–Ω–æ—É—Ç–±—É–∫:
 ‚Ä¢ scene_pipeline_demo.ipynb: –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∏–∞—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö JSON –∏–∑ data/diarized_samples, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ScenePipeline,
 ‚Ä¢ —Ç—Ä–∏ —ç—Ç–∞–ø–∞ –≤—ã–≤–æ–¥–∞:
 ‚Ä¢ –∏—Å—Ö–æ–¥–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã (id/start/end/speaker/text),
 ‚Ä¢ —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ 
 ‚Ä¢ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω—ã –ø–æ —Å–ø–∏–∫–µ—Ä–∞–º (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–ø–∏–∫–µ—Ä–∞, scene/style/details, –≥–æ—Ç–æ–≤—ã–π visual_prompt –ø–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π).

### –ê–Ω–¥—Ä–µ–π –ó–æ—Ç–æ–≤:
1. –û–±—É—á–∞—é—â–∏–π –ø–∞–π–ø–ª–∞–π–Ω:

‚Ä¢ —á–∏—Å—Ç—ã–π –∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–ª–∏—Ç SOVA-–¥–∞—Ç–∞—Å–µ—Ç–∞,
‚Ä¢ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ —Ä—É—Å—Å–∫–∏–π,
‚Ä¢ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–∏—Ç—ã—Ö/–∫–æ—Ä–æ—Ç–∫–∏—Ö –∞—É–¥–∏–æ,
‚Ä¢ –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–ª–ª–∞—Ç–æ—Ä, –ø—Ä–∏–≤–æ–¥—è—â–∏–π –∞—É–¥–∏–æ –∫ –Ω—É–∂–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É Whisper (80√ó3000),
‚Ä¢ LoRA-–æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è Whisper-small (–æ–±—É—á–∞—é—Ç—Å—è Q/V-–ø—Ä–æ–µ–∫—Ü–∏–∏),
‚Ä¢ –ø–∞—Ç—á forward PEFT –ø–æ–¥ input_features,
‚Ä¢ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π TrainingArguments —Å FP16/BF16 –∏ –ø—Ä–æ–≥—Ä–µ–≤–æ–º,
‚Ä¢ –æ–±—É—á–µ–Ω–∏–µ –¥–æ N —à–∞–≥–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–µ—Ä–∞ + –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞,
‚Ä¢ sanity-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å –Ω–∞ val_ds.

2. –ò–Ω—Ñ–µ—Ä–µ–Ω—Å-–ø–∞–π–ø–ª–∞–π–Ω:

‚Ä¢ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∏ LoRA-–∞–¥–∞–ø—Ç–µ—Ä–∞,
‚Ä¢ —Ç–æ–Ω–∫–∞—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ,
‚Ä¢ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ val_ds.

3. –î–∏–∞—Ä–∏–∑–∞—Ü–∏—è + ASR:

‚Ä¢ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω pyannote speaker-diarization-3.1, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ GPU,
‚Ä¢ —Ñ—É–Ω–∫—Ü–∏—è diarize_and_transcribe, –∫–æ—Ç–æ—Ä–∞—è:
-–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—É–¥–∏–æ –∏ –ø—É—Ç—å –∫ wav,
-–¥–µ–ª–∞–µ—Ç –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—é –∏ ASR –ø–æ –∫–∞–∂–¥–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É,
-–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏ speaker/start/end/text/duration/max_new_tokens.
‚Ä¢ —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (videoplayback.m4a, 20—Å),
‚Ä¢ —ç–∫—Å–ø–æ—Ä—Ç –¥–∏–∞—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON.

### –ú–∏—Ö–∞–∏–ª –ü–∞–≤–ª–æ–≤:
1. –°–∫—Ä–∞–ø–∏–Ω–≥ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ –∫–æ–º–ø–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ Audio-Text –∏ Text-Image. –î–∞—Ç–∞—Å–µ—Ç—ã –±—ã–ª–∏ –æ—á–∏—â–µ–Ω—ã –æ—Ç –º—É—Å–æ—Ä–∞, –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã –∏ –∑–∞–ª–∏—Ç—ã –Ω–∞ HuggingFace
2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–∞—Ç–∞—Å–µ—Ç—É, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–æ–¥–∞–ª—å–Ω–æ—Å—Ç–∏.
3. –ö—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è:
1. –°–¥–µ–ª–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –≤—ã–≥—Ä—É–∑–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–µ–π –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ vLLM.
2. –ù–∞–ø–∏—Å–∞—Ç—å –±—ç–∫—ç–Ω–¥ –Ω–∞ —Ñ–ª–∞—Å–∫–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ–ª–∏.
3. –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å—ã–Ω–π gradio –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º).
4. –ù–∞–ø–∏—Å–∞—Ç—å docker compose, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –≤ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∞—Ö.

## –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç:
–ò—Ç–æ–≥–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω –º–æ–¥–µ–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π: –ê—É–¥–∏–æ –Ω–∞ –≤—Ö–æ–¥ -> –¢–µ–∫—Å—Ç, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Å –ø–æ–º–æ—â—å—é –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏ -> –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞, –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –µ–≥–æ –≤ –≤–∏–¥ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è text2image –º–æ–¥–µ–ª–∏, –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π -> –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–∑ –ø—Ä–æ–º–ø—Ç–∞.
